name: challenge04-app

on:
  push:
    branches: [main, develop]
    paths:
      - "technical-challenges/entregas/challenge-04/**"
      - "technical-challenges/devops/challenge-04/**"
  workflow_dispatch:
    inputs:
      environment:
        description: "Ambiente (staging ou prod)"
        required: true
        default: "staging"

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_REGISTRY: ""
  EKS_CLUSTER_NAME: ${{ vars.EKS_CLUSTER_NAME }}
  K8S_NAMESPACE: ${{ vars.K8S_NAMESPACE }}
  API_DEPLOYMENT: ${{ vars.API_DEPLOYMENT }}
  FRONT_DEPLOYMENT: ${{ vars.FRONT_DEPLOYMENT }}
  API_IMAGE: ${{ vars.API_IMAGE }}
  FRONT_IMAGE: ${{ vars.FRONT_IMAGE }}
  API_CONTEXT: technical-challenges/devops/challenge-04/api
  FRONT_CONTEXT: technical-challenges/devops/challenge-04/web

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'prod' || 'staging') }}
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Validar variaveis obrigatorias
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          EKS_CLUSTER_NAME: ${{ env.EKS_CLUSTER_NAME }}
          K8S_NAMESPACE: ${{ env.K8S_NAMESPACE }}
          API_DEPLOYMENT: ${{ env.API_DEPLOYMENT }}
          FRONT_DEPLOYMENT: ${{ env.FRONT_DEPLOYMENT }}
          ECR_API_REPOSITORY: ${{ vars.ECR_API_REPOSITORY }}
          ECR_FRONT_REPOSITORY: ${{ vars.ECR_FRONT_REPOSITORY }}
          API_IMAGE: ${{ env.API_IMAGE }}
          FRONT_IMAGE: ${{ env.FRONT_IMAGE }}
        run: |
          set -euo pipefail
          : "${AWS_REGION:?Defina AWS_REGION em Actions Variables}"
          : "${AWS_ROLE_TO_ASSUME:?Defina AWS_ROLE_TO_ASSUME em Actions Secrets}"
          : "${EKS_CLUSTER_NAME:?Defina EKS_CLUSTER_NAME em Actions Variables}"
          : "${K8S_NAMESPACE:?Defina K8S_NAMESPACE em Actions Variables}"
          : "${API_DEPLOYMENT:?Defina API_DEPLOYMENT em Actions Variables}"
          : "${FRONT_DEPLOYMENT:?Defina FRONT_DEPLOYMENT em Actions Variables}"
          if [ -z "${API_IMAGE}" ] && [ -z "${{ vars.ECR_API_REPOSITORY }}" ]; then
            echo "Configure ECR_API_REPOSITORY em Actions Variables ou forneca API_IMAGE" >&2
            exit 1
          fi
          if [ -z "${FRONT_IMAGE}" ] && [ -z "${{ vars.ECR_FRONT_REPOSITORY }}" ]; then
            echo "Configure ECR_FRONT_REPOSITORY em Actions Variables ou forneca FRONT_IMAGE" >&2
            exit 1
          fi

      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login no ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Descobrir registry
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "ECR_REGISTRY=${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com" >> "$GITHUB_ENV"

      - name: Build/push API (opcional)
        env:
          IMAGE_TAG: ${{ github.sha }}-${{ github.ref_name }}-api
        run: |
          set -euo pipefail
          if [ -f "${API_CONTEXT}/Dockerfile" ]; then
            IMAGE_URI="${ECR_REGISTRY}/${{ vars.ECR_API_REPOSITORY || 'challenge-04-api' }}:${IMAGE_TAG}"
            docker build -t "${IMAGE_URI}" "${API_CONTEXT}"
            docker push "${IMAGE_URI}"
            echo "API_IMAGE_URI=${IMAGE_URI}" >> "$GITHUB_ENV"
          elif [ -n "${API_IMAGE}" ]; then
            echo "API_IMAGE_URI=${API_IMAGE}" >> "$GITHUB_ENV"
            echo "Usando imagem de API fornecida em variaveis." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Nenhuma imagem de API fornecida e nenhum Dockerfile encontrado em ${API_CONTEXT}" >&2
            exit 1
          fi

      - name: Build/push Front (opcional)
        env:
          IMAGE_TAG: ${{ github.sha }}-${{ github.ref_name }}-web
        run: |
          set -euo pipefail
          if [ -f "${FRONT_CONTEXT}/Dockerfile" ]; then
            IMAGE_URI="${ECR_REGISTRY}/${{ vars.ECR_FRONT_REPOSITORY || 'challenge-04-web' }}:${IMAGE_TAG}"
            docker build -t "${IMAGE_URI}" "${FRONT_CONTEXT}"
            docker push "${IMAGE_URI}"
            echo "FRONT_IMAGE_URI=${IMAGE_URI}" >> "$GITHUB_ENV"
          elif [ -n "${FRONT_IMAGE}" ]; then
            echo "FRONT_IMAGE_URI=${FRONT_IMAGE}" >> "$GITHUB_ENV"
            echo "Usando imagem de Front fornecida em variaveis." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Nenhuma imagem Front fornecida e nenhum Dockerfile encontrado em ${FRONT_CONTEXT}" >&2
            exit 1
          fi

      - name: Instalar ferramentas de deploy
        run: sudo apt-get update && sudo apt-get install -y gettext-base

      - name: Atualizar kubeconfig (EKS)
        run: aws eks update-kubeconfig --name "${EKS_CLUSTER_NAME}" --region "${AWS_REGION}"

      - name: Criar namespace se nao existir
        run: kubectl get ns "${K8S_NAMESPACE}" || kubectl create ns "${K8S_NAMESPACE}"

      - name: Renderizar manifests
        env:
          NAMESPACE: ${{ env.K8S_NAMESPACE }}
          API_APP: ${{ env.API_DEPLOYMENT }}
          FRONT_APP: ${{ env.FRONT_DEPLOYMENT }}
          API_IMAGE_URI: ${{ env.API_IMAGE_URI }}
          FRONT_IMAGE_URI: ${{ env.FRONT_IMAGE_URI }}
        run: |
          envsubst < technical-challenges/entregas/challenge-04/k8s/api-deployment.yaml > /tmp/api-deployment.yaml
          envsubst < technical-challenges/entregas/challenge-04/k8s/api-service.yaml > /tmp/api-service.yaml
          envsubst < technical-challenges/entregas/challenge-04/k8s/front-deployment.yaml > /tmp/front-deployment.yaml
          envsubst < technical-challenges/entregas/challenge-04/k8s/front-service.yaml > /tmp/front-service.yaml

      - name: Deploy para Kubernetes
        run: |
          kubectl apply -f /tmp/api-deployment.yaml -f /tmp/api-service.yaml
          kubectl apply -f /tmp/front-deployment.yaml -f /tmp/front-service.yaml
